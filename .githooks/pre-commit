#!/usr/bin/env bash
set -euo pipefail

nix_files=$(git diff --cached --name-only --diff-filter=ACMR -- '*.nix')
sh_files=$(git diff --cached --name-only --diff-filter=ACMR -- '*.sh')
json_files=$(git diff --cached --name-only --diff-filter=ACMR -- '*.json')
yaml_files=$(git diff --cached --name-only --diff-filter=ACMR -- '*.yml' '*.yaml')
md_files=$(git diff --cached --name-only --diff-filter=ACMR -- '*.md')

if [ -z "$nix_files" ] && [ -z "$sh_files" ] && [ -z "$json_files" ] && [ -z "$yaml_files" ] && [ -z "$md_files" ]; then
  exit 0
fi

failed=0

if [ -n "$nix_files" ]; then
  echo "Checking Nix files..."

  if command -v nixfmt &>/dev/null; then
    if ! echo "$nix_files" | xargs nixfmt --check 2>&1; then
      echo "nixfmt: formatting issues found. Run 'nixfmt \$(git diff --cached --name-only -- \"*.nix\")' to fix."
      failed=1
    fi
  else
    echo "warning: nixfmt not found, skipping format check (enter nix-shell to get tools)"
  fi

  if command -v deadnix &>/dev/null; then
    if ! echo "$nix_files" | xargs deadnix 2>&1; then
      echo "deadnix: unused code detected."
      failed=1
    fi
  else
    echo "warning: deadnix not found, skipping (enter nix-shell to get tools)"
  fi

  if command -v statix &>/dev/null; then
    if ! echo "$nix_files" | xargs statix check -- 2>&1; then
      echo "statix: anti-patterns detected."
      failed=1
    fi
  else
    echo "warning: statix not found, skipping (enter nix-shell to get tools)"
  fi
fi

if [ -n "$sh_files" ]; then
  echo "Checking shell scripts..."

  if command -v shellcheck &>/dev/null; then
    if ! echo "$sh_files" | xargs shellcheck 2>&1; then
      echo "shellcheck: issues found in shell scripts."
      failed=1
    fi
  else
    echo "warning: shellcheck not found, skipping (enter nix-shell to get tools)"
  fi
fi

prettier_files="$json_files $yaml_files $md_files"
prettier_files=$(echo "$prettier_files" | xargs)

if [ -n "$prettier_files" ]; then
  echo "Checking JSON/YAML/Markdown formatting..."

  if command -v prettier &>/dev/null; then
    if ! echo "$prettier_files" | xargs prettier --check 2>&1; then
      echo "prettier: formatting issues found. Run 'prettier --write <files>' to fix."
      failed=1
    fi
  else
    echo "warning: prettier not found, skipping (enter nix-shell to get tools)"
  fi
fi

if [ -n "$json_files" ]; then
  echo "Validating JSON..."

  if command -v jq &>/dev/null; then
    for f in $json_files; do
      if ! jq empty "$f" 2>&1; then
        echo "jq: invalid JSON in $f"
        failed=1
      fi
    done
  else
    echo "warning: jq not found, skipping (enter nix-shell to get tools)"
  fi
fi

if [ -n "$yaml_files" ]; then
  echo "Checking YAML..."

  if command -v yamllint &>/dev/null; then
    if ! echo "$yaml_files" | xargs yamllint -d relaxed 2>&1; then
      echo "yamllint: issues found in YAML files."
      failed=1
    fi
  else
    echo "warning: yamllint not found, skipping (enter nix-shell to get tools)"
  fi
fi

if [ -n "$md_files" ]; then
  echo "Checking Markdown..."

  if command -v markdownlint &>/dev/null; then
    if ! echo "$md_files" | xargs markdownlint 2>&1; then
      echo "markdownlint: issues found in Markdown files."
      failed=1
    fi
  else
    echo "warning: markdownlint not found, skipping (enter nix-shell to get tools)"
  fi
fi

if [ "$failed" -ne 0 ]; then
  echo "Pre-commit checks failed. Fix the issues above or use --no-verify to skip."
  exit 1
fi

echo "All checks passed."

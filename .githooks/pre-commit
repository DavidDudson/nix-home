#!/usr/bin/env bash
set -euo pipefail

nix_files=$(git diff --cached --name-only --diff-filter=ACMR -- '*.nix')
sh_files=$(git diff --cached --name-only --diff-filter=ACMR -- '*.sh')

if [ -z "$nix_files" ] && [ -z "$sh_files" ]; then
  exit 0
fi

failed=0

if [ -n "$nix_files" ]; then
  echo "Checking Nix files..."

  if command -v nixfmt &>/dev/null; then
    if ! echo "$nix_files" | xargs nixfmt --check 2>&1; then
      echo "nixfmt: formatting issues found. Run 'nixfmt \$(git diff --cached --name-only -- \"*.nix\")' to fix."
      failed=1
    fi
  else
    echo "warning: nixfmt not found, skipping format check (enter nix-shell to get tools)"
  fi

  if command -v deadnix &>/dev/null; then
    if ! echo "$nix_files" | xargs deadnix 2>&1; then
      echo "deadnix: unused code detected."
      failed=1
    fi
  else
    echo "warning: deadnix not found, skipping (enter nix-shell to get tools)"
  fi

  if command -v statix &>/dev/null; then
    if ! echo "$nix_files" | xargs statix check -- 2>&1; then
      echo "statix: anti-patterns detected."
      failed=1
    fi
  else
    echo "warning: statix not found, skipping (enter nix-shell to get tools)"
  fi
fi

if [ -n "$sh_files" ]; then
  echo "Checking shell scripts..."

  if command -v shellcheck &>/dev/null; then
    if ! echo "$sh_files" | xargs shellcheck 2>&1; then
      echo "shellcheck: issues found in shell scripts."
      failed=1
    fi
  else
    echo "warning: shellcheck not found, skipping (enter nix-shell to get tools)"
  fi
fi

if [ "$failed" -ne 0 ]; then
  echo "Pre-commit checks failed. Fix the issues above or use --no-verify to skip."
  exit 1
fi

echo "All checks passed."
